# Malt

**JSON駆動のHomebrew開発サービス**

<img src="https://koriym.github.io/homebrew-malt/malt.jpg" width="180" alt="麦芽を持つモルコ、若い少女">

Maltは、Homebrewのみを使用してプロジェクト固有の開発環境（IaC）を作成するJSON駆動の開発環境マネージャーです。
1つのJSONファイルでスタックを定義し、ポータブルな`malt/`ディレクトリでチームがどこでも再現できるようにします。

## 動機

Dockerは優れたコンテナ化ツールですが、ローカル開発に対してその完全な分離アプローチが常に必要かどうか疑問を持ちました：

- macOS開発者はしばしばパフォーマンスの問題に直面します（ボリュームマウントを通じた遅いファイルシステムI/O）
- 多くの開発ワークフローでは、完全なコンテナは過剰かもしれません
- Devbox.jsonのようなツールが特に開発環境向けに登場しています

Maltは以下の軽量な代替手段を提供します：
- 最小限のオーバーヘッドでプロジェクト固有の環境を作成します
- プロジェクト間の分離を維持しながらサービスをネイティブに実行します
- 複雑な統合シナリオが必要な場合はDockerと並行して動作します

コンテナを置き換えるのではなく、Maltは開発フェーズで重要なこと（速度、透明性、シンプルさ）に焦点を当てることでコンテナを補完します。

## 概要

Maltはローカル開発環境に宣言的アプローチを取ります。単一のJSONファイルで完全なスタックを定義します - PHPのバージョン、Webサーバー、データベース、キャッシュソリューション、拡張機能、さらにはgitやwgetなどの開発ツールも - そしてMaltが残りを処理します。複雑なセットアップスクリプトはなく、環境の不一致もなく、シンプルなJSONだけです。

Maltは完全な開発環境ソリューションを目指すのではなく、特にサービスのインストールと制御に焦点を当てています。この焦点を絞ったアプローチにより、軽量でわかりやすさを維持しています。

`malt.json`をインフラストラクチャの`composer.json`と考えてください - これはプロジェクトのインフラストラクチャ依存関係の単一の信頼できる情報源として機能します。`composer install`がPHP依存関係を取り込むのと同様に、`malt install && malt start`はインフラストラクチャ依存関係をセットアップします。

MaltはHomebrew formula（公式）エコシステム全体を活用し、任意のHomebrewパッケージをプロジェクト依存関係として宣言しインストールすることができます。これは従来の個別の`brew install`コマンドを手動で実行するアプローチを置き換え、チーム全員が正確に同じツールとサービスを持つことを保証します。

## 主な機能
- **コードとしてのインフラ**: `malt/`はセットアップとログを保持し、チーム全体で共有可能。
- **JSON駆動の設定**: セットアップ間の一貫性を確保します。
- **Homebrew駆動**: 余分な依存関係は必要ありません。
- **サービス管理**: PHP、MySQLなどをシームレスに処理します。
- **ネイティブパフォーマンス**: 仮想化オーバーヘッドなしで直接ファイルシステムアクセス。
- **選択的分離**: 重いコンテナなしでポートベースの分離。

## インストール

```bash
brew tap shivammathur/php
brew tap shivammathur/extensions
brew tap koriym/malt
brew install malt
```

## クイックスタート

### 1. プロジェクトを初期化する

```bash
cd your-project
malt init
```

これにより、プロジェクトディレクトリに`malt.json`ファイルが作成されます:

```json
{
  "project_name": "myapp",
  "public_dir": "public",
  "dependencies": [
    "php@8.4",
    "mysql@8.0",
    "composer",
    "redis",
    "nginx",
    "wget",
    "wrk"
  ],
  "ports": {
    "php": [9000],
    "redis": [6379],
    "memcached": [11211],
    "nginx": [80, 443],
    "httpd": [8080, 8443],
    "mysql": [3306]
  },
  "php_extensions": [
    "xdebug",
    "redis",
    "apcu"
  ]
}
```

このファイルをプロジェクトの要件に合わせてカスタマイズしてください。

### 2. 依存関係をインストールする

```bash
malt install
```

これにより、`malt.json`で定義されたすべてのサービスと拡張機能がインストールされます。

### 3. 環境ファイルを作成する

```bash
malt create
```

これにより、プロジェクト内の[**malt**ディレクトリ](https://github.com/koriym/homebrew-malt/tree/1.x/malt)に必要なすべての設定ファイルが生成されます。

### 4. サービスを開始する

```bash
malt start
```

すべてのサービスは、プロジェクトに合わせた設定で開始されます。

### 5. サービスを停止する

```bash
malt stop
```

### 既存のプロジェクトの場合

すでに`malt.json`と`malt`ディレクトリが設定されているプロジェクト（例えば、既存のチームに参加する場合や2台目の開発マシンを設定する場合）では、3つのコマンドだけが必要です：

```bash
malt install    # 依存関係をインストール
malt start      # サービスを開始
source <(malt env)  # 環境変数とエイリアスを設定
```

これにより、新しいチームメンバーのオンボーディングが信じられないほど速くなり、チーム全体と複数のマシン間で一貫した開発環境が確保されます。`source <(malt env)`コマンドにより、すべての正しいバイナリバージョンと、プロジェクト用に簡略化されたサービス接続にすぐにアクセスできます。

## ディレクトリ構造

Maltはプロジェクト内に以下のディレクトリ構造を作成します：

```
your-project/
├── malt/
│   ├── conf/       # すべてのサービスの設定ファイル
│   ├── logs/       # ログファイル
│   ├── tmp/        # 一時ファイル
│   └── var/        # データファイル（MySQL等）
├── public/         # ドキュメントルート（public_dir）
└── malt.json       # 環境定義
```

`malt/`ディレクトリは`malt.json`とペアになり、ポータブルなインフラストラクチャコードとして機能します。プロジェクト相対的なプレースホルダーを使用することで、チームはそれをクローンし、同じセットアップをどこにでも展開できます—パスの調整は必要ありません。

### バージョン管理の考慮事項

Gitなどのバージョン管理を使用する場合、`malt.json`ファイルをコミットするべきですが、生成されたコンテンツのほとんどは無視するべきです。以下は推奨される`.gitignore`パターンです：

```
# 基本設定を除くMalt生成コンテンツを無視
malt/logs/
malt/tmp/
malt/var/
malt/conf/*.tmp
```

これにより、環境定義はチームと共有されますが、一時ファイル、ログ、ランタイムデータはリポジトリに含まれません。

## コマンド

- `malt init` - 新しいmalt.json設定を作成する
- `malt install` - malt.jsonから依存関係をインストールする
- `malt create` - 環境をセットアップする
- `malt start` - サービスを開始する
- `malt stop` - サービスを停止する
- `malt env` - 環境変数を表示する
- `malt info` - 現在のプロジェクトに関する情報を表示する

## サービス設定

Maltは以下のサービスを管理します：

- **PHP-FPM** - カスタム拡張機能を持つ複数のPHPバージョン
- **Nginx** - 複数の仮想ホスト
- **Apache HTTPD** - 複数のポートと仮想ホスト
- **MySQL** - カスタム設定
- **Redis** - キャッシュサーバー
- **Memcached** - 分散メモリキャッシング

## 環境変数

プロジェクトの環境変数を設定するには、次のコマンド（bash、zsh、および類似のシェルと互換性があります）を使用します：

```bash
source <(malt env)
```

このコマンドは、便利なパスエイリアスとサービス接続を設定します：

### パスエイリアス
Maltは自動的に、`malt.json`で定義した各バイナリの特定のバージョンへのシンボリックリンクを作成します：

- `php` → `php@8.4`（プロジェクト固有のPHPバージョン）
- `mysql` → `mysql@8.0`（プロジェクトで指定されたMySQLバージョン）
- `redis-cli` → プロジェクトのRedisポート
- そして定義されたすべての依存関係についても同様

これにより、手動で指定しなくても、常にプロジェクトに正しいバージョンを使用していることが保証されます。

### サービス接続エイリアス
Maltはまた、正しい設定でサービスに接続するための便利なポート固有のエイリアスも作成します：

```bash
alias mysql@3306="mysql --defaults-file=/Users/username/your-project/malt/conf/my_3306.cnf -h 127.0.0.1"
alias mysql@3307="mysql --defaults-file=/Users/username/your-project/malt/conf/my_3307.cnf -h 127.0.0.1"
alias redis-cli@6379="redis-cli -h 127.0.0.1 -p 6379"
```

これは特に、同じサービスの複数のインスタンス（例えば、`mysql@3306`、`mysql@3307`）を同時に使用する場合に役立ちます。複雑な接続文字列や設定ファイルのパスを覚える必要なく、ポート固有のエイリアスを使用するだけで、すべての正しい設定を持つ正しいインスタンスにすぐに接続できます。

## よくある質問

### Maltは「自分のマシンでは動作する」問題をどのように解決しますか？

適切に構造化されたアプリケーションでは、MaltはDockerの完全な分離なしでほとんどの環境の不一致に対処します：

1. **宣言的依存関係** - `malt.json`は必要なすべてのサービスとバージョンを明示的に定義します
2. **設定の一貫性** - `malt/`ディレクトリにはすべての環境固有の設定が含まれています
3. **プロジェクトの分離** - 異なるプロジェクト間の明確な分離

このアプローチは、コンテナよりも優れたパフォーマンスと透明性を維持しながら、ほとんどの最新アプリケーションに十分です。複雑なOS依存関係を持つ高度に結合されたシステムでは、Dockerが依然として必要かもしれません - そして必要に応じてMaltと一緒に使用できます。

### MaltはDockerの代替品ですか？

いいえ、それらは異なる目的を持ち、共存できます：

- **Malt**は、速度と透明性が必要な日常の開発に使用します
- **Docker**は、統合テスト、ステージング、本番環境に使用します

多くのチームは両方を使用しています：迅速な開発サイクルにはMaltを、後の段階での本番環境の類似性を確保するためにDockerを使用しています。

### 同じプロジェクトでMaltとDockerを併用できますか？

もちろんです！以下のことができます：
- 速度を重視するコアコンポーネントをMaltで開発する
- Dockerで統合テストを実行する
- Malt生成の設定をDockerfileを作成するための基盤として使用する

この組み合わせアプローチにより、両方の世界の良い点を得ることができます。

## なぜMaltか？

他の開発環境ソリューションとは異なり、Maltは：

- 代替手段よりも劇的に軽量 - VMやコンテナがないことは以下を意味します：
  - DockerやVMと比較して最小限のメモリフットプリント
  - ネイティブなファイルシステムのパフォーマンス（特にmacOSで重要）
  - 抽象化レイヤーなしでログ、データ、設定ファイルに直接アクセス
  - 仮想化のオーバーヘッドなしですぐに起動
  - ネイティブなバイナリやツールへの直接アクセス
- 事実上依存関係がない - macOS開発者にとって標準であるHomebrewだけ
- コンテナにラップされていない、すでに知っているネイティブパッケージを使用
- シンプルなJSONを通じて完全な設定の柔軟性を提供
- チーム全体で一貫した環境を作成
- 複雑さなしにインフラストラクチャ・アズ・コードの原則に従う

### リソース使用量の比較

| ソリューション | メモリ使用量 | ディスク容量 | 起動時間 | ファイルI/Oパフォーマンス |
|--------------|------------|------------|----------|----------------------|
| Malt         | 低          | 低         | 即時      | ネイティブ            |
| Docker       | 中-高        | 中         | 数秒      | 低下（特にmacOSで）     |
| VM           | 高          | 高         | 数分      | 大幅に低下            |

### Malt vs Devbox.json

MaltとDevbox.jsonはどちらもJSONを使用して開発環境を定義しますが、アプローチが異なります：

| 機能 | Malt | Devbox.json |
|---------|------|------------|
| **エコシステム** | Homebrewパッケージ | Nixパッケージ |
| **焦点** | サービスのインストールと制御 | より広範な開発環境 |
| **設定** | シンプルなJSON構造 | より複雑なスキーマ |
| **サービス管理** | 組み込みのサービス制御 | サービス実行への焦点が少ない |
| **プロジェクト構造** | 設定/ログを持つ`malt/`を作成 | 最小限のファイルシステム変更 |

Maltは以下に最適です：
- 管理が必要な相互依存する複数のサービスを持つプロジェクト
- ログと設定への直接アクセスを求めるチーム
- よりシンプルなサービス指向の開発環境

Devbox.jsonは以下に適しているかもしれません：
- より広範な環境管理を求めるチーム
- 複雑な依存関係グラフを持つプロジェクト
- より包括的な開発環境

どちらのツールもクロスプラットフォームで宣言的な設定を提供します。

## 🍺Malt Prompt Brewery

[Malt Prompt Brewery](https://koriym.github.io/homebrew-malt/prompt.html)を使用して、malt.jsonからインフラストラクチャコードを生成します。

## ドキュメンテーション

完全なドキュメントは[https://koriym.github.io/homebrew-malt/index.html](https://koriym.github.io/homebrew-malt/index.html)で利用可能です。

## ライセンス

MIT

## 貢献

貢献は歓迎します！お気軽にプルリクエストを提出してください。
