# Malt

**JSONによるHomebrew開発環境**

<img src="https://koriym.github.io/homebrew-malt/malt.jpg" width="180" alt="Moruko">

MaltはJSON設定によりHomebrewだけで、プロジェクト単位の開発環境（IaC）を実現します。 
スタック構成を1つのJSONファイルで定義し、ポータブルなmalt/ディレクトリを使用してチームがどこでも再現できるようにします。

## 概要

Maltは、ローカル開発環境に宣言的アプローチを取ります。PHPバージョン、Webサーバー、データベース、キャッシングソリューション、拡張機能、さらにはgitやwgetなどの開発ツールなど、スタック全体を単一のJSONファイルで定義すれば、あとはMaltが処理します。複雑なセットアップスクリプトや環境の不一致はなく、シンプルなJSONだけです。

MaltはHomebrewフォーミュラのエコシステム全体を活用し、任意のHomebrewパッケージをプロジェクト依存関係として宣言・インストールできます。これにより、個々の`brew install`コマンドを手動で実行する従来のアプローチを置き換え、チーム全員が全く同じツールとサービスを持つことを保証します。

## 主な機能
- **Infrastructure as Code**: `malt/`がセットアップとログを保持し、チーム間で共有可能。
- **JSON設定**: セットアップ間の一貫性を確保。
- **Homebrewを活用**: 追加の依存関係が不要。
- **サービス管理**: PHP、MySQLなどをシームレスに処理。

## インストール

```bash
brew tap shivammathur/php
brew tap shivammathur/extensions
brew tap koriym/malt
brew install malt
```

## クイックスタート

### 1. プロジェクトの初期化

```bash
cd your-project
malt init
```

これにより、プロジェクトディレクトリに`malt.json`ファイルが作成されます：

```json
{
  "project_name": "myapp",
  "public_dir": "public",
  "dependencies": [
    "php@8.4",
    "mysql@8.0",
    "composer",
    "redis",
    "nginx",
    "wget",
    "wrk"
  ],
  "ports": {
    "php": [9000],
    "redis": [6379],
    "memcached": [11211],
    "nginx": [80, 443],
    "httpd": [8080, 8443],
    "mysql": [3306]
  },
  "php_extensions": [
    "xdebug",
    "redis",
    "apcu"
  ]
}
```

このファイルをプロジェクトの要件に合わせてカスタマイズしてください。

### 2. 依存関係のインストール

```bash
malt install
```

これにより、`malt.json`で定義されたすべてのサービスと拡張機能がインストールされます。

### 3. 環境ファイルの作成

```bash
malt create
```

これにより、プロジェクト内の[**malt** ディレクトリ](https://github.com/koriym/homebrew-malt/tree/1.x/malt)に必要なすべての設定ファイルが生成されます。

### 4. サービスの開始

```bash
malt start
```

すべてのサービスがプロジェクトに合わせた設定で起動します。

### 5. サービスの停止

```bash
malt stop
```

### 既存のプロジェクトの場合

すでに`malt.json`と`malt`ディレクトリが設定されているプロジェクト（例：既存のチームに参加する場合や、2台目の開発マシンをセットアップする場合）では、3つのコマンドだけが必要です：

```bash
malt install    # 依存関係のインストール
malt start      # サービスの開始
source <(malt env)  # 環境変数とエイリアスのセットアップ
```

これにより、新しいチームメンバーのオンボーディングが信じられないほど速くなり、チーム全体および複数のマシン間で一貫した開発環境が確保されます。`source <(malt env)`コマンドを使用すると、すべての正しいバイナリバージョンと簡略化されたサービス接続にすぐにアクセスできます。

## ディレクトリ構造

Maltはプロジェクト内に次のディレクトリ構造を作成します：

```
your-project/
├── malt/
│   ├── conf/       # すべてのサービスの構成ファイル
│   ├── logs/       # ログファイル
│   ├── tmp/        # 一時ファイル
│   └── var/        # データファイル（MySQLなど）
├── public/         # ドキュメントルート（public_dir）
└── malt.json       # 環境定義
```

`malt/`ディレクトリは`malt.json`と対になり、ポータブルなインフラコードとして機能します。プロジェクト相対のプレースホルダーを使用することで、チームはこれをクローンして同じセットアップをどこにでも展開できます—パスの調整は必要ありません。

### バージョン管理の考慮事項

Gitなどのバージョン管理を使用する場合、`malt.json`ファイルはコミットし、生成されたコンテンツのほとんどは無視する必要があります。推奨される`.gitignore`パターンは次のとおりです：

```
# 基本設定以外のMalt生成コンテンツを無視
malt/logs/
malt/tmp/
malt/var/
malt/conf/*.tmp
malt/conf/*.temp
```

これにより、環境定義はチームと共有されますが、一時ファイル、ログ、ランタイムデータはリポジトリに含まれません。

## コマンド

- `malt init` - 新しいmalt.json設定の作成
- `malt install` - malt.jsonから依存関係をインストール
- `malt create` - 環境のセットアップ
- `malt start` - サービスの開始
- `malt stop` - サービスの停止
- `malt env` - 環境変数の表示
- `malt info` - 現在のプロジェクトに関する情報の表示

## サービス設定

Maltは以下のサービスを管理します：

- **PHP-FPM** - カスタム拡張機能を持つ複数のPHPバージョン
- **Nginx** - 複数の仮想ホスト
- **Apache HTTPD** - 複数のポートと仮想ホスト
- **MySQL** - カスタム設定
- **Redis** - キャッシングサーバー
- **Memcached** - 分散メモリキャッシング

## 環境変数

プロジェクトの環境変数を設定するには、次のコマンドを使用します（bash、zshなどのシェルと互換性があります）：

```bash
source <(malt env)
```

このコマンドは、便利なパスエイリアスとサービス接続をセットアップします：

### パスエイリアス
Maltは自動的に、`malt.json`で定義した各バイナリの特定バージョンへのシンボリックリンクを作成します：

- `php` → `php@8.4`（プロジェクト固有のPHPバージョン）
- `mysql` → `mysql@8.0`（プロジェクトで指定されたMySQLバージョン）
- `redis-cli` → プロジェクトのRedisバージョン
- 定義されたすべての依存関係について同様

これにより、手動で指定しなくても、常にプロジェクトに適したバージョンを使用できます。

### サービス接続エイリアス
Maltはまた、正しい設定でサービスに接続するための便利なポート固有のエイリアスも作成します：

```bash
alias mysql@3306="mysql --defaults-file=/Users/username/your-project/malt/conf/my_3306.cnf -h 127.0.0.1"
alias mysql@3307="mysql --defaults-file=/Users/username/your-project/malt/conf/my_3307.cnf -h 127.0.0.1"
alias redis-cli@6379="redis-cli -h 127.0.0.1 -p 6379"
```

これは、同じサービスの複数のインスタンス（例：`mysql@3306`、`mysql@3307`）を同時に使用する場合に特に便利です。複雑な接続文字列や設定ファイルのパスを覚える必要なく、ポート固有のエイリアスを使用するだけで、すべての正しい設定を持つ適切なインスタンスにすぐに接続できます。

## なぜMaltなのか？

他の開発環境ソリューションとは異なり、Maltは：

- 代替手段よりも劇的に軽量 - VMやコンテナがないため：
  - DockerやVMと比較して最小限のメモリフットプリントです
  - ネイティブファイルシステムのパフォーマンス（特にmacOSで重要）
  - 抽象化レイヤーなしでログ、データ、設定ファイルに直接アクセスします
  - ポートマッピングの複雑さやネットワークレイヤーがありません
  - 仮想化のオーバーヘッドなしで即時起動
  - ネイティブバイナリやツールへの直接アクセス
- macOS開発者にとって標準的なHomebrewだけで、実質的に依存関係がゼロです
- コンテナにラップされていない、すでによく知っているネイティブパッケージを使用します
- シンプルなJSONを通じて完全な設定の柔軟性を提供します
- チーム間で一貫した環境を作成します
- 複雑さなしにインフラストラクチャ・アズ・コードの原則に従います

### リソース使用量の比較

| ソリューション | メモリ使用量 | ディスク容量 | 起動時間 | ファイルI/Oパフォーマンス |
|----------|--------------|------------|--------------|----------------------|
| Malt     | 低          | 低        | 即時      | ネイティブ               |
| Docker   | 中〜高  | 中     | 数秒      | 低下（特にmacOSで） |
| VM       | 高         | 高       | 数分      | 大幅に低下 |

### 開発重視 vs コンテナ分離

Dockerは本番環境や特定の開発シナリオには優れていますが、Maltはそこまでの完全な分離ががすべての開発環境に必要なのかという疑問から生まれました。：

- ほとんど全てのWebサービス（Apache、MySQLなど）はすでに異なる設定で複数のインスタンスを実行するように設計されています
- 従来のネイティブのサービスの使いにくさはグローバルな設定に依存していたためと考え、プロジェクトごとに設定やログを設置することにしました。
- ポート分離は開発目的には十分な分離であることが多いです
- 整理された設定、ログやデータディレクトリなど快適なファイルシステムへの直接アクセスが可能です。
- 複雑になりがちなxdebugやhot reloadの設定も容易に
- 当然ですが全ての仮想化の問題を根本的に避けることができます

コンテナ仮想化のオーバーヘッドは開発ワークフローに対して特別な利点を提供しているでしょうか。もしそうでもないならMaltの出番かもしれません。
Maltは、開発者が最も重要なことに集中できるように、最小限の抽象化と最大限の透明性を提供します。

### 本番環境への移行パス

Maltの重要な利点の一つは、本番デプロイ設定を作成する際の有用性です：

- JSON設定が環境要件の単一の真実源(SSOT)として機能します
- `malt.json`をAIツールに提供することで、Dockerfile、Docker Composeファイル、Kubernetesマニフェスト、その他のデプロイ構成を簡単に生成できます。
- Maltの設定の宣言的な性質により、様々なデプロイ形式へのAI支援変換に理想的
- 依存関係のバージョン、サービス設定、環境変数がすでに明確に定義されているため、変換が簡単です。
- このアプローチは、ゼロから始めるよりも効果的に開発環境と本番環境のギャップを埋めます。

このワークフローは、従来の開発環境セットアップをコンテナ化またはオーケストレーション環境に移行するよりも明確で簡単であり、インフラ全体での一貫性を促進します。

#### 🍺Malt Prompt Brewery

[Malt Prompt Brewery](https://koriym.github.io/homebrew-malt/prompt.html)を使用して、malt.jsonからインフラコードを生成しましょう。

## ドキュメント

完全なドキュメントは[https://koriym.github.io/homebrew-malt/index.html](https://koriym.github.io/homebrew-malt/index.html)で入手できます。

## ライセンス

MIT

## 貢献

貢献は歓迎します！お気軽にプルリクエストを提出してください。